<html>

<head>

    <!-- we want to use D3, so this is where D3.js gets called-->
    <script type="text/javascript" src="libraries/d3/d3.min.js"></script>
    <link rel="stylesheet" type="text/css" href="cancer_waiting_time.css">

    <!--title of the webpage-->
    <title>D3</title>

</head>

<body>

<!-- simple text heading-->
<h1>Cancer Waiting Time</h1>

<div></div>
<script>
    var datapath = "data/Sheet_4.csv";
    var barwidth = 15;
    var barmargin = 5;
    var width = 800;
    var height = 1100;
    var margin = 50;
    var chartHeight = 500;


    d3.csv(datapath, function (error, data) {
        console.log(data);
        var myData = data;

        var extentTT = d3.extent(myData, function (d) {
            return d.TOTAL_TREATED * 0.001;
        });
        var extentP = d3.extent(myData, function (d) {
            return d.Avg_PERFORMANCE * 100;
        });

        var extentStandard = d3.extent((myData, function (d) {
            return d.STANDARD;
        }))

        var minTT = d3.min(extentTT);
        var maxTT = d3.max(extentTT);
        var maxP = d3.max(extentP);

        var scale = d3.scaleLinear()
            .domain([0, maxTT])
            .range([0, chartHeight]);

        var cScale = d3.scaleLinear()
            .domain([0, maxP])
            .range([0, chartHeight]);

        var xScale = d3.scaleOrdinal()
            .domain(["2WW", "31 Days", "62 Days"])
            .range([margin, margin + 16 * (barwidth + barmargin), margin + 26 * (barwidth + barmargin),
                margin + 35 * (barwidth + barmargin)]);

        var x_axis = d3.axisTop(xScale);

        var yaxisScale1 = d3.scaleLinear()
            .domain([0, maxTT])
            .range([chartHeight + margin, margin]);
        var yaxisScale2 = d3.scaleLinear()
            .domain([0, maxP])
            .range([chartHeight + margin, margin]);

        var y_axis1 = d3.axisLeft(yaxisScale1);
        var y_axis2 = d3.axisRight(yaxisScale2);

        var colorScale10 = d3.scaleOrdinal(d3.schemeCategory10);
        var colorScale20 = d3.scaleOrdinal(d3.schemeCategory20);

        var tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0.0);

        d3.select("div")
            .append("svg")
            .attr("id", "plot")
            .attr("width", width)
            .attr("height", height);

        d3.select("svg")
            .selectAll("g")
            .data(myData)
            .enter()
            .append("g")
            .append("rect")
            .attr("width", barwidth)
            .attr("height", function (d) {
                return scale(d.TOTAL_TREATED * 0.001);
            })
            .attr("x", function (d, i) {
                return i * (barwidth + barmargin) + margin;
            })
            .attr("y", function (d, i) {
                return chartHeight + margin - scale(d.TOTAL_TREATED * 0.001);
            })
            .style("fill", function (d) {
                return colorScale20(d.CANCER_TYPE);
            })
            .on("mouseenter", function (d, i) {
                d3.select(this)
                    .style("stroke", "black")
                    .style("strokeWidth", "2px");
            })
            .on("mouseout", function (d) {
                d3.select(this)
                    .style("stroke", "white");
                tooltip.style("opacity", 0.0);
            })
            .on("mouseover", function (d) {
                tooltip.html("Cancer Type: " + d.CANCER_TYPE + "<br/>"
                    + "Standard:         " + d.STANDARD + "<br/>"
                    + "Total Treated:    " + d.TOTAL_TREATED + "<br/>"
                    + "Avg. Performance: " + d.Avg_PERFORMANCE)
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY + 20) + "px")
                    .style("opacity", 1.0);
            })
            .on("mousemove", function (d) {
                tooltip.style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY + 20) + "px");
            });

        d3.selectAll("g")
            .append("circle")
            .attr("cx", function (d, i) {
                return i * (barwidth + barmargin) + margin + barwidth / 2;
            })
            .attr("cy", function (d) {
                return chartHeight + margin - cScale(d.Avg_PERFORMANCE * 100);
            })
            .attr("r", 4)
            .style("fill", function (d) {
                return colorScale10(d.STANDARD);
            })
            .on("mouseenter", function (d, i) {
                d3.select(this)
                    .style("stroke", "black")
                    .style("strokeWidth", "2px");
            })
            .on("mouseout", function (d) {
                d3.select(this)
                    .style("stroke", "white");
                tooltip.style("opacity", 0.0)
                    .style("left", "1000");
            })
            .on("mouseover", function (d) {
                tooltip.html("Cancer Type: " + d.CANCER_TYPE + "<br/>"
                    + "Standard:         " + d.STANDARD + "<br/>"
                    + "Total Treated:    " + d.TOTAL_TREATED + "<br/>"
                    + "Avg. Performance: " + d.Avg_PERFORMANCE)
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY + 20) + "px")
                    .style("opacity", 1.0);
            })
            .on("mousemove", function (d) {
                tooltip.style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY + 20) + "px");
            });

        d3.selectAll("g")
            .append("text")
            .text(function (d) {
                return d.CANCER_TYPE;
            })
            .attr("transform", function (d, i) {
                return "translate (" + (margin + i * (barwidth + barmargin)) + "," +
                    (chartHeight + margin + barmargin) + ") rotate(90)";
            });

        d3.select("svg")
            .append("g")
            .attr("transform", "translate (0, " + (margin - 10) + ")")
            .call(x_axis)
            .append("text")
            .text("Standard")
            .attr("class", "label")
            .attr("transform", "translate (" + ((margin + 35 * (barwidth + barmargin)) / 2) + "," + (-30) + ")");

        d3.select("svg")
            .append("g")
            .attr("transform", "translate (" + (margin - barmargin) + ", 0)")
            .call(y_axis1)
            .append("text")
            .text("Total Treated (K)")
            .attr("class", "label")
            .attr("transform", "translate (" + (-(2 * barwidth)) + ", " + (chartHeight / 2) + ") rotate(-90)");

        d3.select("svg")
            .append("g")
            .attr("transform", "translate (" + (margin + 35 * (barwidth + barmargin)) + ", 0)")
            .call(y_axis2)
            .append("text")
            .text("Avg. Performance (%)")
            .attr("class", "label")
            .attr("transform", "translate (" + (barwidth + 2 * barmargin) + ", " + (chartHeight / 2) + ") rotate(90)");
    });
</script>


</body>

</html>